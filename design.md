# 多币种分发工具后台逻辑设计

## 用户管理
1. 用户登录

* 用户凭用户名和密码登录
* 登陆后即可查看历史信息


## excel表格上传
1. 校验数据的合法性，保存数据到数据库
* 校验数据的合法性包括，打币目的地址是否正确，比如，ontology链的地址是Base58编码格式，Eth链是hex格式并且长度固定。打币数量是否合法，不同的币种精度不一样，ont必须是整数，ong可以带小数点
* 保存数据到数据库
excel表格包含两列，打币目的地址和打币数量，由于同一个excel表格中打币目的地址和打币数量有可能同时一样，
为了确定表的数据唯一性，需要增加数据库自增的Id来区分。
2. 从数据库中加载excel表格的数据
3. 初始化Manager，生成打币地址
4. 计算该次发放需要发放的总金额，总的发放笔数，用于校验数据库中的数据是否正确，
评估总的手续费，

## 转账
根据事件 进行转账

1. 校验操作员签名
2. 判断是否已经处于转账中状态，如果是则结束，
3. 继续下面的流程

### 正常转账
点击转账按钮，该事件进入转账中状态，该事件对应的转账按钮不可以再点击，也就是处于转账中的事件不能再次点击转账
1. 启动从数据库中加载数据协程1
2. 启动发送交易协程2并初始化TransferChannel, 启动验证交易协程3并初始化VerifyTxChannel
3. 协程1加载的数据向TransferChannel中添加数据，直到完成，关闭TransferChannel
4. 发送交易协程2处理逻辑
   1. 从数据库中加载交易信息
   2. 如果1.中没有加载到数据，构造交易然后保存到数据库，如果1.中加载到数据，判断交易状态是不是交易成功，如果不是交易成功，重新验证交易是否成功，如果成功，更新交易状态
   3. 发送交易，更新交易状态为转账中， 将交易发送信息添加到VerifyTxChannel
5. 验证交易
   1. 根据交易hash查询交易事件
   2. 如果没查到事件，等待 尝试次数 * 3秒的时间，尝试次数不超过6次
   3. 如果交易成功，更新交易状态为交易成功，在尝试6次后都不能确定交易是否成功，暂定为交易失败，更新数据库交易状态为交易失败

### 异常转账

正常转账结束后，如果有交易状态不是交易成功，则可以继续点击转账按钮，然后重复正常转账的逻辑


## 交易记录查询

表字段包括 自增Id, 事件，币种，打币目的地址，打币数量,交易hash， 交易内容，交易状态
为了提高查询的效率建立  自增Id, 事件，地址的联合索引，